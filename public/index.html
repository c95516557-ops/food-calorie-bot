<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food'oGram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {margin:0;background:#000;color:#fff;font-family:system-ui;text-align:center;padding:30px;}
    h1 {font-size:28px;margin-bottom:8px;}
    p {opacity:0.8;margin-bottom:40px;}
    button {background:#00C853;color:#fff;border:none;padding:18px 40px;font-size:20px;border-radius:50px;cursor:pointer;}
    #result {margin:30px auto;max-width:400px;text-align:left;background:#111;padding:20px;border-radius:16px;}
    .msg {margin:12px 0;padding:12px;border-radius:18px;max-width:88%;word-wrap:break-word;}
    .user {background:#00C853;margin-left:auto;border-bottom-right-radius:4px;}
    .ai {background:#222;margin-right:auto;border-bottom-left-radius:4px;}
    #inputArea {position:fixed;bottom:0;left:0;right:0;background:#111;padding:12px;display:flex;gap:12px;}
    input {flex:1;padding:15px;background:#222;border:none;border-radius:30px;color:#fff;font-size:17px;}
    #sendBtn {background:#00C853;width:54px;height:54px;border-radius:50%;font-size:28px;}
  </style>
</head>
<body>

  <h1>Food'oGram</h1>
  <p>10 секунд примерное время ожидания</p>
  <button id="photoBtn">Сделать фото</button>

  <div id="result" style="display:none">
    <div id="analysis"></div>
    <div id="messages" style="max-height:50vh;overflow-y:auto;margin:20px 0;"></div>

    <div id="inputArea">
      <input type="text" id="question" placeholder="Спросить…" autocomplete="off">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const photoBtn = document.getElementById('photoBtn');
    const result = document.getElementById('result');
    const analysis = document.getElementById('analysis');
    const messages = document.getElementById('messages');
    const input = document.getElementById('question');
    const sendBtn = document.getElementById('sendBtn');

    let history = []; // сюда будет и фото, и весь дальнейший чат

    // Главная кнопка — открывает галерею + камеру
    photoBtn.onclick = () => {
      photoBtn.disabled = true;
      photoBtn.textContent = "Обработка…";

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.capture = 'environment'; // сразу предлагает камеру
      fileInput.onchange = e => {
        if (e.target.files[0]) processPhoto(e.target.files[0]);
      };
      fileInput.click();
    };

    async function processPhoto(file) {
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result;

        const res = await fetch('/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64: base64 })
        });
        const json = await res.json();

        if (json.success) {
          showAnalysis(json.data);
          // Запоминаем фото + результат в историю чата
          history = [
            { role: "user", parts: [{ inlineData: { 
              data: base64.split(',')[1], 
              mimeType: base64.includes('png') ? 'image/png' : 'image/jpeg' 
            }}]},
            { role: "model", parts: [{ text: JSON.stringify(json.data) }] }
          ];
        } else {
          analysis.innerHTML = `<p style="color:#faa">Ошибка: ${json.error}</p>`;
          history = [];
        }

        result.style.display = 'block';
        photoBtn.style.display = 'none';
        input.focus();
      };
      reader.readAsDataURL(file);
    }

    function showAnalysis(data) {
      analysis.innerHTML = `
        <h3>${data.dish}</h3>
        <p><b>Калории:</b> ${data.calories} ккал</p>
        <p>Белки: ${data.protein}г • Жиры: ${data.fat}г • Углеводы: ${data.carbs}г</p>
        <p><b>Ещё идеи:</b></p>
        ${data.recipes.map(r => `<p>• ${r}</p>`).join('')}
      `;
    }

    // Отправка любого сообщения в чат (на любую тему)
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      addMessage(text, 'user');
      input.value = '';
      addMessage('Печатает…', 'ai');

      history.push({ role: "user", parts: [{ text }] });

      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ history })
      });
      const json = await res.json();

      messages.lastChild.remove(); // убираем "Печатает…"
      addMessage(json.reply || 'Не смог ответить :(', 'ai');
      history.push({ role: "model", parts: [{ text: json.reply }] });
    }

    function addMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `msg ${sender}`;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    input.onkeydown = e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendMessage());
  </script>
</body>
</html>
